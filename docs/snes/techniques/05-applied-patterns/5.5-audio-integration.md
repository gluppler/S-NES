# 5.5 Audio Integration

## Overview

SNES audio integration patterns for SPC700 communication, music playback, and sound effect management.


## SPC700 Communication

**Pattern**: Communicate with SPC700 audio processor via $2140-$2143 ports. Upload BRR audio data and control playback.

**Implementation**:
```asm
; SPC700 communication ports
APUIO0 = $2140        ; CPU-APU communication port 0
APUIO1 = $2141        ; CPU-APU communication port 1
APUIO2 = $2142        ; CPU-APU communication port 2
APUIO3 = $2143        ; CPU-APU communication port 3

; SPC700 boot and upload (simplified example)
; See SPC700 Boot documentation for complete implementation
init_audio:
    ; Boot SPC700 (see spc700-boot.md for full sequence)
    jsr spc700_boot
    
    ; Upload BRR audio data
    ; (SPC700 upload code would go here)
    
    rts

; Update audio (call once per frame)
update_audio:
    ; Send commands to SPC700 via APUIO ports
    ; (Audio update code would go here)
    
    rts

; Play music
play_music:
    ; A = song index
    ; Send play command to SPC700 via APUIO0
    sta APUIO0
    rts

; Play sound effect
play_sfx:
    ; A = sound effect index
    ; Send SFX command to SPC700 via APUIO1
    sta APUIO1
    rts

; Stop music
stop_music:
    ; Send stop command to SPC700
    lda #$00
    sta APUIO0
    rts
```

## Music vs SFX Priority

**Pattern**: Prioritize sound effects over music when SPC700 voices conflict. Reserve specific voices for SFX and others for music.

**Voice Allocation** (SPC700 has 8 voices):
- **Voices 0-1**: Sound effects (priority)
- **Voices 2-7**: Music

**Implementation**:
```asm
; Audio priority system (WRAM)
sfx_playing = $7E3000    ; SFX active flags (bit per voice, 8 voices)
music_voices = $7E3001   ; Music voice mask (voices 2-7)

; Initialize audio priority
init_audio_priority:
    stz sfx_playing
    lda #%11111100       ; Music uses voices 2-7
    sta music_voices
    rts

; Play sound effect with priority
play_sfx_priority:
    ; A = sound effect index
    ; X = voice (0-1 for SFX priority)
    
    ; Check if voice is reserved for music
    txa
    tay
    lda bit_table,y
    and music_voices
    bne sfx_blocked      ; Voice reserved for music
    
    ; Check if SFX already playing on this voice
    lda bit_table,y
    and sfx_playing
    bne sfx_blocked      ; SFX already playing
    
    ; Play SFX via SPC700
    ; (Send command to SPC700 via APUIO ports)
    sta APUIO1           ; SFX index
    stx APUIO2           ; Voice number
    
    ; Mark voice as SFX
    lda bit_table,y
    ora sfx_playing
    sta sfx_playing
    
    rts
    
sfx_blocked:
    ; SFX blocked, try alternative voice
    rts

; Update audio with priority
update_audio_priority:
    ; Update SPC700 (send commands via APUIO)
    ; (Audio update code would go here)
    
    ; Check if SFX finished (read from SPC700 status)
    ; (Status check code would go here)
    
    rts

; Bit table for 8 voices
bit_table:
    .byte %00000001, %00000010, %00000100, %00001000
    .byte %00010000, %00100000, %01000000, %10000000
```

## Simple Direct SPC700 Control

**Pattern**: For simple games, directly control SPC700 DSP registers without a music engine. Use lookup tables for notes and simple patterns.

**Note**: SNES audio requires SPC700 boot and BRR format audio data. Direct control is more complex than NES APU.

**Implementation**:
```asm
; Simple note table (SPC700 pitch values)
; Note: SPC700 uses different pitch format than NES APU
note_table:
    .word $1000  ; C4 (example values)
    .word $1100  ; D4
    .word $1200  ; E4
    .word $1300  ; F4
    .word $1400  ; G4
    .word $1500  ; A4
    .word $1600  ; B4
    .word $1700  ; C5

; Play note on SPC700 voice 0
; Note: This requires SPC700 to be booted and BRR data loaded
play_note:
    ; A = note index (0-7)
    asl a           ; Multiply by 2 (word table)
    tay
    
    ; Send pitch to SPC700 via APUIO ports
    ; (SPC700 command protocol would go here)
    lda note_table,y
    sta APUIO2      ; Pitch low
    lda note_table+1,y
    sta APUIO3      ; Pitch high
    
    ; Send play command
    lda #$01        ; Voice 0, play command
    sta APUIO0
    
    rts

; Simple sound effect (jump)
play_jump_sfx:
    ; Send SFX command to SPC700
    ; (SPC700 command protocol would go here)
    lda #$01        ; SFX index
    sta APUIO1
    lda #$00        ; Voice 0
    sta APUIO2
    lda #$80        ; Play command
    sta APUIO0
    
    rts
```

## Cross-References

- [SPC700 Boot](../../hardware/audio-spc700/spc700-boot.md) - Audio processor initialization
- [CPU-APU Protocol](../../hardware/audio-spc700/cpu-apu-protocol.md) - Communication via $2140-$2143
- [DSP Registers](../../hardware/audio-spc700/dsp-registers.md) - S-DSP register map
- [BRR Format](../../hardware/audio-spc700/brr-format.md) - Audio compression format
- [SNES Documentation Index](../../README.md) - Complete SNES documentation
